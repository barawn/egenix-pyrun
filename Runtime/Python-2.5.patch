--- Modules/getpath.c.orig	2012-04-23 00:57:29.779087102 +0200
+++ Modules/getpath.c	2012-04-23 00:57:37.979086891 +0200
@@ -444,10 +444,21 @@ calculate_path(void)
 	if (progpath[0] != SEP)
 		absolutize(progpath);
 	strncpy(argv0_path, progpath, MAXPATHLEN);
 	argv0_path[MAXPATHLEN] = '\0';
 
+    /* For PyRun we don't need all the machinery to setup sys.path, since
+       we're doing that in pyrun.py, so just use some sane defaults and
+       return. */
+    if (Py_FrozenFlag) {
+	strncpy(prefix, PREFIX, MAXPATHLEN);
+	strncpy(exec_prefix, EXEC_PREFIX, MAXPATHLEN);
+	module_search_path = (char *)PyMem_Malloc(MAXPATHLEN + 1);
+	strncpy(module_search_path, PREFIX "/lib/python" VERSION, MAXPATHLEN);
+	return;
+    }
+
 #ifdef WITH_NEXT_FRAMEWORK
 	/* On Mac OS X we have a special case if we're running from a framework.
 	** This is because the python home should be set relative to the library,
 	** which is in the framework, not relative to the executable, which may
 	** be outside of the framework. Except when we're in the build directory...
diff -ur ../Python-2.5.6-orig/Makefile.pre.in ./Makefile.pre.in
--- ../Python-2.5.6-orig/Makefile.pre.in	2008-09-22 02:22:44.000000000 +0200
+++ ./Makefile.pre.in	2012-07-24 10:52:31.000000000 +0200
@@ -458,7 +458,7 @@
 		$(SIGNAL_OBJS) \
 		$(MODOBJS) \
 		$(srcdir)/Modules/getbuildinfo.c
-	$(CC) -c $(PY_CFLAGS) -DSVNVERSION=\"`LC_ALL=C $(SVNVERSION)`\" -o $@ $(srcdir)/Modules/getbuildinfo.c
+	$(CC) -c $(PY_CFLAGS) -DSVNVERSION="\"`LC_ALL=C $(SVNVERSION)`\"" -o $@ $(srcdir)/Modules/getbuildinfo.c
 
 Modules/getpath.o: $(srcdir)/Modules/getpath.c Makefile
 	$(CC) -c $(PY_CFLAGS) -DPYTHONPATH='"$(PYTHONPATH)"' \
diff -ur ../Python-2.5.6-orig/Modules/getbuildinfo.c ./Modules/getbuildinfo.c
--- ../Python-2.5.6-orig/Modules/getbuildinfo.c	2007-06-08 01:56:18.000000000 +0200
+++ ./Modules/getbuildinfo.c	2012-07-24 10:52:31.000000000 +0200
@@ -48,5 +48,5 @@
 	static const char svnversion[] = SVNVERSION;
 	if (svnversion[0] != '$')
 		return svnversion; /* it was interpolated, or passed on command line */
-	return "exported";
+	return "Unversioned directory";
 }
diff -ur ../Python-2.5.6-orig/Python/sysmodule.c ./Python/sysmodule.c
--- ../Python-2.5.6-orig/Python/sysmodule.c	2011-04-17 22:36:17.000000000 +0200
+++ ./Python/sysmodule.c	2012-07-24 10:52:31.000000000 +0200
@@ -1016,7 +1016,7 @@
 
 
 	svnversion = _Py_svnversion();
-	if (strcmp(svnversion, "exported") != 0)
+	if (strcmp(svnversion, "Unversioned directory") != 0 && strcmp(svnversion, "exported") != 0)
 		svn_revision = svnversion;
 	else if (istag) {
 		len = strlen(_patchlevel_revision);
diff -ur ../Python-2.5.6-orig/configure.in ./configure.in
--- ../Python-2.5.6-orig/configure.in	2008-12-13 15:13:52.000000000 +0100
+++ ./configure.in	2012-07-24 10:52:31.000000000 +0200
@@ -692,7 +692,7 @@
 then
 	SVNVERSION="svnversion \$(srcdir)"
 else
-	SVNVERSION="echo exported"
+	SVNVERSION="echo Unversioned directory"
 fi
 
 case $MACHDEP in
--- Python-2.5.6/Python/sysmodule.c	2011-04-17 22:36:17.000000000 +0200
+++ Python/sysmodule.c	2013-04-23 19:43:37.130281826 +0200
@@ -731,10 +731,51 @@ extern PyObject *_Py_GetDXProfile(PyObje
 
 #ifdef __cplusplus
 }
 #endif
 
+/*** PyRun Extension ***************************************************/
+
+#define SYS_SETFLAG(c_flag, flag_name)		\
+    if (strcmp(flagname, flag_name) == 0) {	\
+	old_value = c_flag;			\
+	if (value != -1)			\
+	    c_flag = value;			\
+    } else
+
+static PyObject *
+sys_setflag(PyObject* self, PyObject* args)
+{
+    char *flagname;
+    int value = -1, old_value = value;
+
+    if (!PyArg_ParseTuple(args, "s|i", &flagname, &value))
+        goto onError;
+
+    SYS_SETFLAG(Py_DebugFlag, "debug")
+    SYS_SETFLAG(Py_OptimizeFlag, "optimize")
+    SYS_SETFLAG(Py_VerboseFlag, "verbose")
+    {
+        PyErr_SetString(PyExc_ValueError,
+                        "unknown flag name");
+	goto onError;
+    }
+    return PyInt_FromLong((long)old_value);
+
+ onError:
+    return NULL;
+}
+
+#undef SYS_SETFLAG
+
+PyDoc_STRVAR(sys_setflag__doc__,
+"_setflag(flagname, value) -> old_value\n\
+Set the given interpreter flag and return its previous value.");
+
+/*** End of PyRun Extension ***********************************************/
+
+
 static PyMethodDef sys_methods[] = {
 	/* Might as well keep this in alphabetic order */
 	{"callstats", (PyCFunction)PyEval_GetCallStats, METH_NOARGS,
 	 callstats_doc},
 	{"_current_frames", sys_current_frames, METH_NOARGS,
@@ -789,10 +830,11 @@ static PyMethodDef sys_methods[] = {
 	 getcheckinterval_doc},
 #ifdef HAVE_DLOPEN
 	{"setdlopenflags", sys_setdlopenflags, METH_VARARGS,
 	 setdlopenflags_doc},
 #endif
+	{"_setflag", sys_setflag, METH_VARARGS, sys_setflag__doc__},
 	{"setprofile",	sys_setprofile, METH_O, setprofile_doc},
 	{"setrecursionlimit", sys_setrecursionlimit, METH_VARARGS,
 	 setrecursionlimit_doc},
 #ifdef WITH_TSC
 	{"settscdump", sys_settscdump, METH_VARARGS, settscdump_doc},
